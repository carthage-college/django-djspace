{% extends "home.html" %}
{% block title %}
    WSGC {{reg_type|capfirst}} Dashboard &mdash; Carthage College
{% endblock %}
{% block css %}
    <link href="//www.carthage.edu/themes/europa/assets/css/master.css"
        type="text/css" rel="stylesheet">
    <link href="//www.carthage.edu/themes/europa/assets/css/addons.css"
       type="text/css" rel="stylesheet">
    <link href="//www.carthage.edu/themes/shared/css/forms.css"
        rel="stylesheet" type="text/css">
    <link href="//www.carthage.edu/themes/shared/css/tables.css"
        type="text/css" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
        type="text/css" rel="stylesheet">
    <link href="//www.carthage.edu/static/vendor/jquery/ui/datepicker/css/smoothness/jquery-ui-1.10.4.custom.min.css"
        rel="stylesheet" type="text/css" />
    <!--[if lt IE 9]>
        <script src="//www.carthage.edu/themes/shared/js/html5shiv.js"
            type="text/javascript"></script>
    <![endif]-->
{% endblock css %}
{% block extra_style %}
{{block.super}}
<link rel="stylesheet"
    href="//www.carthage.edu/static/vendor/jquery/plugins/fancybox/jquery.fancybox.css"
    type="text/css" media="screen" />
{% endblock %}
{% block extra_javascript %}
<script src="//www.carthage.edu/static/vendor/jquery/ui/datepicker/js/jquery-ui-1.10.4.custom.min.js"
    type="text/javascript" charset="utf-8"></script>
<script src="//www.carthage.edu/static/vendor/jquery/plugins/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript"
    src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<script src="https://malsup.github.io/min/jquery.blockUI.min.js"
    type="text/javascript"></script>
<script type="text/javascript">
  $(document).ready(function(){

    function validateURL(textval) {
      var regexp = /(http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;
      return regexp.test(textval);
    }
    function FilesStatus() {
        $.ajax({
            type: "POST",
            url:  "{% url 'files_status' %}",
            dataType: "html",
            success: function(response) {
                if ( response == "True") {
                    //console.log(response);
                    $("#messages").remove();
                }
            },
            error: function(response) {
                alert(response);
            }
        });
    }

    $('.upload-file').change(function(){
      var $dis = $(this);
      var file = this.files[0];
      var $fname = $dis.attr("name");
      var $content_type = $dis.attr("data-content-type");
      var $oid = $dis.attr("data-oid");
      var $fawe = $dis.parent().next('.fa-times');
      var $update = false;
      if ($fawe.length == 0) {
        // we have a replace file manoeuvre
        $update = true;
        $fawe = $dis.parent().next('a');
      }
      var $fawe_error = '<i class="fa fa-times fa-exclamation-triangle red" aria-hidden="true"></i>';
      var name = file.name;
      var size = file.size;
      var type = file.type;
      /* console.log(name,size,type); */
      if(file.name.length < 5) {
        alert("Is that a proper filename?");
      }
      else if(file.size > 50000000) {
        alert("That file is too big");
      } else {
        var formData = new FormData($('#user-files')[0]);
        formData.append( 'field_name', $fname );
        if ($content_type) {
            formData.append( 'content_type', $content_type );
            formData.append( 'oid', $oid );
        }
        var def = $.Deferred(), promise = def.promise();
        $fawe.html('<i class="fa fa-times fa-cog fa-spin fa-fw"></i>');
        $.ajax({
            url: '{% url 'user_files' %}',
            type: 'POST',
            xhr: function() {
                myXhr = jQuery.ajaxSettings.xhr();
                // if upload property exists
                if(myXhr.upload){
                    myXhr.upload.addEventListener('progress', function(event) {
                        var percent = 0;
                        var position = event.loaded || event.position; /*event.position is deprecated*/
                        var total = event.total;
                        if (event.lengthComputable) {
                            percent = Math.ceil(position / total * 100);
                            def.notify(percent);
                        }
                    }, false);
                }
                return myXhr;
            },
            // Ajax events
            success: function(data) {
                /* determine if we can remove warning message
                   about missing files */
                FilesStatus();
                /*
                * Workaround for Chrome browser // Delete the fake path
                */
                if(navigator.userAgent.indexOf('Chrome')) {
                    var catchFile = $(":file").val().replace(/C:\\fakepath\\/i, '');
                }
                else {
                    var catchFile = $(":file").val();
                }
                if (data.substr(0,4) == "Fail") {
                  //console.log("error = " + data);
                  $("#file-fail-error").html(data);
                  $.fancybox.open([{
                    href : '#file-fail'
                  }]);
                  $fawe.html($fawe_error);
                  // prevents subsequent errors
                  $dis.val("");
                } else {
                  $.growlUI('Success', "File uploaded.");
                  // removes the file name from display
                  $dis.val("");
                  if ($update == false){
                    $fawe.replaceWith(data);
                  }else{
                    $fawe.replaceWith(data);
                  }
                }
                data = "";
            },
            error: errorHandler = function(data) {
                alert("500 server error: Something went awry...");
            },
            // Form data
            data: formData,
            // Options to tell jQuery not to process data
            // or worry about the content-type
            cache: false,
            contentType: false,
            processData: false
        }, 'json'); /* end ajax method */
      } /* end if/then logic */
    }); /* end :file change() method */
    $(".flight-demo").blur(function() {
        var $dis = $(this);
        var $did = $dis.attr('id');
        var $val = $dis.val();
        var $field = $dis.attr("name");
        var $cid = $dis.attr("data-content-type");
        var $oid = $dis.attr("data-oid");
        var $fawe = $('#' + $did + '_missing');
        var $fawe_done = '<i class="fa fa-thumbs-o-up blue" aria-hidden="true"></i>';
        var $data = {
            'cid':$cid,
            'oid':$oid,
            'field':$field,
            'value':$val
        };
        if ($val != '' && validateURL($val)) {
          $.ajax ({
            type: "POST",
            async: true,
            dataType: "html",
            url: "{% url 'set_val' %}",
            data: $data,
            success: function(data) {
              if (data == "success") {
                $fawe.replaceWith($fawe_done);
                $.growlUI('Success', "Flight Demo URL saved.");
                // determine if we can remove warning message about
                // missing files
                FilesStatus();
              }else{
                $.growlUI('Fail', "Please input your URL again.");
              }
            },
            error: function(data) {
              alert("500 server error: Something went awry...");
            }
          });
        } else {
          $.growlUI('Fail', "Please input your URL again.");
        }
    });
    $("#id_proceeding_paper").datepicker({
      firstDay:1,
      changeFirstDay:false,dateFormat:"yy-mm-dd",
      showOn:"both",
      buttonImage:"//www.carthage.edu/themes/shared/img/ico/calendar.gif",
      buttonImageOnly:true,
      onSelect: function(date, instance) {
        var $dis = $(this);
        var $field = $dis.attr("name");
        var $cid = $dis.attr("data-content-type");
        var $oid = $dis.attr("data-oid");
        var $fawe = $('#proceeding-missing');
        var $fawe_done = '<i class="fa fa-thumbs-o-up blue" aria-hidden="true"></i>';
        var $data = {
            'cid':$cid,
            'oid':$oid,
            'field':$field,
            'value':date
        };
        $.ajax ({
          type: "POST",
          async: true,
          dataType: "html",
          url: "{% url 'set_val' %}",
          data: $data,
          success: function(data) {
            if (data == "success") {
              $fawe.replaceWith($fawe_done);
              $.growlUI('Success', "Date saved.");
              /* determine if we can remove warning message
                 about missing files */
              FilesStatus();
            }else{
              $.growlUI('Fail', "Please select your date again.");
            }
          },
          error: function(data) {
            alert("500 server error: Something went awry...");
          }
        });
      }
    });
    $('.filebutt').click(function () {
      $(this).siblings('.upload-file').trigger('click');
    })
  });
</script>
{% endblock %}
{% block page_header %}
    Program Applications
{% endblock %}
{% block content_head %}
    <h1 id="page_title">
        {{user.profile.salutation}}
        {{user.first_name}}
        {{user.profile.second_name}}
        {{user.last_name}}
        <small class="fright" style="margin-right:20px;">
            <a href="{% url 'dashboard_home' %}">
                <i class="fa fa-globe fa-2x"></i></a>
        </small>
        <span id="secondary-dropdown"></span>
    </h1>
{% endblock %}
{% block content %}
{% if messages %}
    {% for message in messages %}
    <div id="messages" class="{{ message.tags }} large-12 medium-12 small-12">
        {{ message }}
    </div>
    {% endfor %}
{% endif %}
<form id="user-files" method="post" action="{% url 'user_files' %}"
  class="form" enctype="multipart/form-data">
<div class="large-6 medium-12 small-12">
{% if reg %}
    <div class="info">
      <h2>Your Applications</h2>
    </div>
    <ul>
    {% for app in applications %}
        <h3 class="application-type">
            {{app.get_application_type}}{% if app.get_content_type.model == "rocketlaunchteam" %}: {{app.name}} {% endif %}
        </h3>
        <li>
            <span class="short-date">
                {{app.date_created|date:"SHORT_DATE_FORMAT"}}
            <a href="{{app.get_absolute_url}}">
            {% if app.project_title %}
                {{app}}
            {% else %}
                Application
            {% endif %}
            </a>
            </span>
            {% if app.status %}
              <fieldset>
                <legend>Requisite Files</legend>
                <ol>
                  <li class="form-group ctrlHolder">
                    <h3>
                      <label for="id_award_acceptance">Award Acceptance [PDF]</label>
                    </h3>
                    <div class="filewrap fleft">
                      <input type="file" class="upload-file"
                        data-content-type="{{app.get_content_type.id}}"
                        data-oid="{{app.id}}"
                        name="award_acceptance" id="id_award_acceptance">
                      <span class='filebutt'>Select File</span>
                      <span class='filevalu'></span>
                    </div>
                    {% if app.award_acceptance %}
                      <a class="fa-wrap" href="{{media_url}}{{app.award_acceptance}}" target="_blank">
                        <i class="fa fa-times fa-file-pdf-o blue" aria-hidden="true"></i></a>
                    {% else %}
                      <i class="fa fa-times red fa-wrap" aria-hidden="true" title="Missing file"></i>
                    {% endif %}
                  </li>
                  {# RocketLaunchTeam creator and student leader can upload requisite files #}
                  {% if app.get_content_type.model == "rocketlaunchteam" %}
                    {% include "dashboard/rocket_launch_team_files.inc.html" %}
                  {% endif %}
                  {% if app.get_content_type.model in rocket_competitions and app.team.status and app.team.leader.id == user.id %}
                    {% include "dashboard/rocket_launch_team_files.inc.html" %}
                  {% endif %}
                  {% if app.get_content_type.model in professional_programs %}
                  <li class="form-group ctrlHolder">
                    <h3><label for="id_invoice">Invoice [PDF]</label></h3>
                    <div class="filewrap fleft">
                      <input type="file" class="upload-file"
                        data-content-type="{{app.get_content_type.id}}"
                        data-oid="{{app.id}}"
                        name="invoice" id="id_invoice">
                      <span class='filebutt'>Select File</span>
                      <span class='filevalu'></span>
                    </div>
                    {% if app.invoice %}
                      <a class="fa-wrap" href="{{media_url}}{{app.invoice}}" target="_blank">
                        <i class="fa fa-times fa-file-pdf-o blue" aria-hidden="true"></i></a>
                    {% else %}
                      <i class="fa fa-times red fa-wrap" aria-hidden="true" title="Missing file"></i>
                    {% endif %}
                  </li>
                  <li class="form-group ctrlHolder">
                    <h3><label for="id_program_match">Program Match [PDF]</label></h3>
                    <div class="filewrap fleft">
                      <input type="file" class="upload-file"
                        data-content-type="{{app.get_content_type.id}}"
                        data-oid="{{app.id}}"
                        name="program_match" id="id_program_match">
                      <span class='filebutt'>Select File</span>
                      <span class='filevalu'></span>
                    </div>
                    {% if app.program_match %}
                      <a class="fa-wrap" href="{{media_url}}{{app.program_match}}" target="_blank">
                        <i class="fa fa-times fa-file-pdf-o blue" aria-hidden="true"></i></a>
                    {% else %}
                      <i class="fa fa-times red fa-wrap" aria-hidden="true" title="Missing file"></i>
                    {% endif %}
                  </li>
                  <li class="form-group ctrlHolder">
                    <h3>
                      <label for="id_payment_information">
                        Payment Information Form [PDF]
                      </label>
                    </h3>
                    <div class="filewrap fleft">
                      <input type="file" class="upload-file"
                        data-content-type="{{app.get_content_type.id}}"
                        data-oid="{{app.id}}"
                        name="payment_information" id="id_payment_information">
                      <span class='filebutt'>Select File</span>
                      <span class='filevalu'></span>
                    </div>
                    {% if app.payment_information %}
                      <a class="fa-wrap" href="{{media_url}}{{app.payment_information}}" target="_blank">
                        <i class="fa fa-times fa-file-pdf-o blue" aria-hidden="true"></i></a>
                    {% else %}
                      <i class="fa fa-times red fa-wrap" aria-hidden="true" title="Missing file"></i>
                    {% endif %}
                  </li>
                  {% endif %} {# end professional programs files #}
                  {% if app.get_content_type.model not in rocket_competitions and app.get_content_type.model != "rocketlaunchteam" %}
                  <li class="form-group ctrlHolder">
                    <h3>
                      <label for="id_interim_report">Interim Report [PDF]</label>
                    </h3>
                    <div class="filewrap fleft">
                      <input type="file" class="upload-file"
                        data-content-type="{{app.get_content_type.id}}"
                        data-oid="{{app.id}}"
                        name="interim_report" id="id_interim_report">
                      <span class='filebutt'>Select File</span>
                      <span class='filevalu'></span>
                    </div>
                    {% if app.interim_report %}
                      <a class="fa-wrap" href="{{media_url}}{{app.interim_report}}" target="_blank">
                        <i class="fa fan-ban fa-file-pdf-o blue" aria-hidden="true"></i></a>
                    {% else %}
                      <i class="fa fa-times red fa-wrap" aria-hidden="true" title="Missing file"></i>
                    {% endif %}
                  </li>
                  <li class="form-group ctrlHolder">
                    <h3><label for="id_final_report">Final Report [PDF]</label></h3>
                    <div class="filewrap fleft">
                      <input type="file" class="upload-file"
                        data-content-type="{{app.get_content_type.id}}"
                        data-oid="{{app.id}}"
                        name="final_report" id="id_final_report">
                      <span class='filebutt'>Select File</span>
                      <span class='filevalu'></span>
                    </div>
                    {% if app.final_report %}
                      <a class="fa-wrap" href="{{media_url}}{{app.final_report}}" target="_blank">
                        <i class="fa fa-times fa-file-pdf-o blue" aria-hidden="true"></i></a>
                    {% else %}
                      <i class="fa fa-times red fa-wrap" aria-hidden="true" title="Missing file"></i>
                    {% endif %}
                  </li>
                  {% endif %}{# rocket exceptions #}
                </ol>
              </fieldset>
            {% endif %}{# appstatus #}
        </li>
    {% endfor %}
    </ul>
{% endif %}
</div>
<div class="column2 large-6 medium-12 small-12">
    {% if approved %}
    <div class="info">
      <h2>Personal Profile Files</h2>
    </div>
    <p>
      <strong>NOTE:</strong>
        The following files will serve all programs to which you have
        submitted an application.
    </p>
    <ol><li>
    <fieldset>
      <legend>All Program Files</legend>
      <ol>
        <li class="form-group ctrlHolder">
          <h3><label for="id_mugshot">Photo [JPG]</label></h3>
          <div class="filewrap fleft">
            <input type="file" class="upload-file"
              name="mugshot" id="id_mugshot">
            <span class='filevalu'></span>
            <span class='filebutt'>Select File</span>
          </div>
          {% if user_files.mugshot.value %}
            <a class="fa-wrap" href="{{media_url}}{{user_files.mugshot.value}}"
              target="_blank">
            <i class="fa fa-times fa-file-image-o blue" aria-hidden="true"></i></a>
          {% else %}
            <i class="fa fa-times red fa-wrap" aria-hidden="true" title="Missing file"></i>
          {% endif %}
        </li>
        <li class="form-group ctrlHolder">
          <h3><label for="id_biography">Biography [PDF]</label></h3>
          <div class="filewrap fleft">
            <input type="file" class="upload-file"
              name="biography" id="id_biography">
            <span class='filevalu'></span>
            <span class='filebutt'>Select File</span>
          </div>
          {% if user_files.biography.value %}
            <a class="fa-wrap" href="{{media_url}}{{user_files.biography.value}}"
              target="_blank">
            <i class="fa fa-times fa-file-pdf-o blue" aria-hidden="true"></i></a>
          {% else %}
            <i class="fa fa-times red fa-wrap" aria-hidden="true" title="Missing file"></i>
          {% endif %}
        </li>
        <li class="form-group ctrlHolder">
          <h3><label for="id_irs_w9">W9 Form [PDF]</label></h3>
          <div class="filewrap fleft">
            <input type="file" class="upload-file"
              name="irs_w9" id="id_irs_w9">
            <span class='filevalu'></span>
            <span class='filebutt'>Select File</span>
          </div>
          {% if user_files.irs_w9.value %}
            <a class="fa-wrap" href="{{media_url}}{{user_files.irs_w9.value}}"
              target="_blank">
            <i class="fa fa-times fa-file-pdf-o blue" aria-hidden="true"></i></a>
          {% else %}
            <i class="fa fa-times red fa-wrap" aria-hidden="true" title="Missing file"></i>
          {% endif %}
        </li>
        <li class="form-group ctrlHolder">
          <h3>
            <label for="id_media_release">Media Release Form [PDF]</label>
          </h3>
          <div class="filewrap fleft">
            <input type="file" class="upload-file"
              name="media_release" id="id_media_release">
            <span class='filevalu'></span>
            <span class='filebutt'>Select File</span>
          </div>
          {% if user_files.media_release.value %}
            <a class="fa-wrap" href="{{media_url}}{{user_files.media_release.value}}"
              target="_blank">
              <i class="fa fa-times fa-file-pdf-o blue" aria-hidden="true"></i></a>
          {% else %}
            <i class="fa fa-times red fa-wrap" aria-hidden="true" title="Missing file"></i>
          {% endif %}
        </li>
      </ol>
    </fieldset>
    </li></ol>
    {% endif %}
    {% if not reg %}
    <h2>Message Center</h2>
    <div class="notice">
    {% else %}
    <div class="info">
      <h2>Grant Application Forms</h2>
    </div>
    <div class="grant-list">
    {% endif %}
    {% if not reg or not status %}
    <i class="fa fa-times red"></i>
    You must update your
    <a href="{% url 'dashboard_profile' %}"
        style="color:blue;">
        registration profile
    </a> before applying for grants from NASA.
    {% else %}
    <div style="margin-left:9px;">
        {% include "dashboard/applications.inc.html" %}
    </div>
    {% endif %}
    </div>
</div> <!-- /.column2 -->
</form>
<!-- file fail modal -->
<div id="file-fail" style="display:none;width:500px;">
    <h2>Your file was not uploaded</h2>
    <p id="file-fail-error" style="font-weight:bold;" class="red">
      Verify that the file is a PDF for documents and JPEG for images.
    </p>
    <p>
        <a href="javascript:$.fancybox.close();">Close</a>
    </p>
</div>
{% endblock %}
