{% extends "home.html" %}
{% block title %}
    WSGC {{reg_type|capfirst}} Registration &mdash; Carthage College
{% endblock %}
{% block css %}
    <link href="//www.carthage.edu/themes/europa/assets/css/master.css"
        type="text/css" rel="stylesheet">
    <link href="//www.carthage.edu/themes/europa/assets/css/addons.css"
        type="text/css" rel="stylesheet">
    <link href="//www.carthage.edu/themes/shared/css/forms.css"
        rel="stylesheet" type="text/css">
    <link href="//www.carthage.edu/themes/shared/css/tables.css"
        type="text/css" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"
        integrity="sha384-XdYbMnZ/QjLh6iI4ogqCTaIjrFk87ip+ekIjefZch0Y+PvJ8CDYtEs1ipDmPorQ+"
        crossorigin="anonymous" type="text/css" rel="stylesheet">
    <!--[if lt IE 9]>
        <script src="//www.carthage.edu/themes/shared/js/html5shiv.js"
            type="text/javascript"></script>
    <![endif]-->
{% endblock %}
{% block extra_javascript %}
<script type="text/javascript">
  $(document).ready(function(){
    $('.upload-file').change(function(){
      var $dis = $(this);
      var file = this.files[0];
      var $fname = $dis.attr("name");
      var $content_type = $dis.attr("data-content-type");
      var $oid = $dis.attr("data-oid");
      var $fawe = $dis.siblings('.fa-ban');
      var name = file.name;
      var size = file.size;
      var type = file.type;
      console.log(name,size,type);
      if(file.name.length < 1) {
        alert("Is that a correct filename?");
      }
      /*
      else if(file.size > 100000) {
        alert("The file is too big");
      }
      */
      else if(file.type != 'image/jpg' && file.type != 'application/pdf' && file.type != 'image/jpeg' ) {
        alert("The file does not match jpg or pdf");
      } else {
        var formData = new FormData($('#user-files')[0]);
        formData.append( 'field_name', $fname );
        if ($content_type) {
            formData.append( 'content_type', $content_type );
            formData.append( 'oid', $oid );
        }
        var def = $.Deferred(), promise = def.promise();
        $fawe.html('<i class="fa fa-cog fa-spin fa-fw"></i>');
        $.ajax({
            url: '{% url 'user_files' %}',  //server script to process data
            type: 'POST',
            xhr: function() {  // custom xhr
                myXhr = jQuery.ajaxSettings.xhr();
                if(myXhr.upload){ // if upload property exists
                    myXhr.upload.addEventListener('progress', function(event) {
                        var percent = 0;
                        var position = event.loaded || event.position; /*event.position is deprecated*/
                        var total = event.total;
                        if (event.lengthComputable) {
                            percent = Math.ceil(position / total * 100);
                            def.notify(percent);
                        }
                    }, false);
                }
                return myXhr;
            },
            // Ajax events
            success: completeHandler = function(data) {
                console.log(data.url);
                console.log(data.path);
                /*
                * Workaround for Chrome browser // Delete the fake path
                */
                if(navigator.userAgent.indexOf('Chrome')) {
                    var catchFile = $(":file").val().replace(/C:\\fakepath\\/i, '');
                }
                else {
                    var catchFile = $(":file").val();
                }
                //var writeFile = $(":file");
                //writeFile.html(document.write(catchFile));
                $dis.val("");
                $fawe.replaceWith(data);
            },
            error: errorHandler = function(data) {
                console.log(data);
                alert("500 server error: Something went awry...");
            },
            // Form data
            data: formData,
            // Options to tell jQuery not to process data or worry about the content-type
            cache: false,
            contentType: false,
            processData: false
        }, 'json'); /* end ajax method */
      } /* end if/then logic */
    }); /* end :file change() method */
  });
</script>
{% endblock %}
{% block page_header %}
    Program Applications
{% endblock %}
{% block content_head %}
    <h1 id="page_title">
        {{user.profile.salutation}}
        {{user.first_name}}
        {{user.profile.second_name}}
        {{user.last_name}}
        <small class="fright" style="margin-right:20px;">
            <a href="{% url 'dashboard_home' %}"><i class="fa fa-globe fa-2x"></i></a>
        </small>
        <span id="secondary-dropdown"></span>
    </h1>
{% endblock %}
{% block content %}
{% if messages %}
    {% for message in messages %}
    <div{% if message.tags %} class="{{ message.tags }} large-12 medium-12 small-12"{% endif %}>
        {{ message }}
    </div>
    {% endfor %}
{% endif %}
<div class="large-7 medium-12 small-12">
{% if user.profile.us_citizen == "Yes" and reg %}
    <div class="info">
      <h2>Your Applications</h2>
    </div>
    <form id="user-files" method="post" action="{% url 'user_files' %}"
      class="form" enctype="multipart/form-data">
    {% for app in user.profile.applications.all %}
        {% if forloop.first %}
            <h3 class="application-type">{{app.get_application_type}}</h3>
            <ul>
        {% else %}
        {% ifchanged app.get_application_type and not forloop.first %}
            </ul>
            <h3 class="application-type">{{app.get_application_type}}</h3>
            <ul>
        {% endifchanged %}
        {% endif %}
        <li>
            <span class="short-date">
                {{app.date_created|date:"SHORT_DATE_FORMAT"}}
            <a href="{{app.get_absolute_url}}">
            {% if app.project_title %}
                {{app}}
            {% else %}
                Application
            {% endif %}
            </a>
            </span>
            {% if app.status %}
              <fieldset>
                <legend>Requisite Files</legend>
                <ol>
                  <li class="form-group ctrlHolder">
                    <h3>
                      <label for="id_award_acceptance">Award Acceptance</label>
                    </h3>
                    <div>
                      <input type="file" class="upload-file"
                        data-content-type="{{app.get_content_type.id}}"
                        data-oid="{{app.id}}"
                        name="award_acceptance" id="id_award_acceptance">
                      {% if app.award_acceptance %}
                        <a href="{{media_url}}{{app.award_acceptance}}" target="_blank">
                          <i class="fa fa-file-pdf-o red" aria-hidden="true"></i></a>
                      {% else %}
                        <i class="fa fa-ban red" aria-hidden="true" title="Missing file"></i>
                      {% endif %}
                    </div>
                  </li>
                  <li class="form-group ctrlHolder">
                    <h3>
                      <label for="id_interim_report">Interim Report</label>
                    </h3>
                    <div>
                      <input type="file" class="upload-file"
                        data-content-type="{{app.get_content_type.id}}"
                        data-oid="{{app.id}}"
                        name="interim_report" id="id_interim_report">
                      {% if app.interim_report %}
                        <a href="{{media_url}}{{app.interim_report}}" target="_blank">
                          <i class="fa fa-file-pdf-o red" aria-hidden="true"></i></a>
                      {% else %}
                        <i class="fa fa-ban red" aria-hidden="true" title="Missing file"></i>
                      {% endif %}
                    </div>
                  </li>
                  <li class="form-group ctrlHolder">
                    <h3><label for="id_final_report">Final Report</label></h3>
                    <div>
                      <input type="file" class="upload-file"
                        data-content-type="{{app.get_content_type.id}}"
                        data-oid="{{app.id}}"
                        name="final_report" id="id_final_report">
                      {% if app.final_report %}
                        <a href="{{media_url}}{{app.final_report}}" target="_blank">
                          <i class="fa fa-file-pdf-o red" aria-hidden="true"></i></a>
                      {% else %}
                        <i class="fa fa-ban red" aria-hidden="true" title="Missing file"></i>
                      {% endif %}
                    </div>
                  </li>
                  {% if user.profile.registration_type != "Undergraduate" or user.profile.registration_type != "Graduate" %}
                  <li class="form-group ctrlHolder">
                    <h3><label for="id_invoice">Invoice</label></h3>
                    <div>
                      <input type="file" class="upload-file"
                        data-content-type="{{app.get_content_type.id}}"
                        data-oid="{{app.id}}"
                        name="invoice" id="id_invoice">
                      <i class="fa fa-ban red" aria-hidden="true" title="Missing file"></i>
                    </div>
                  </li>
                  <li class="form-group ctrlHolder">
                    <h3><label for="id_final_report">Final Report</label></h3>
                    <div>
                      <input type="file" class="upload-file"
                        data-content-type="{{app.get_content_type.id}}"
                        data-oid="{{app.id}}"
                        name="program_match" id="id_program_match">
                      <i class="fa fa-ban red" aria-hidden="true" title="Missing file"></i>
                    </div>
                  </li>
                  {% endif %}
                </ol>
              </fieldset>
            {% endif %}
        </li>
    {% endfor %}
    </ul>
    {% if approved %}
    <hr>
    <fieldset>
    <legend>Requisite Profile Files</legend>
      <p>
        The following files will serve all programs to which you have
        submitted an application.
      </p>
      <ol>
        <li class="form-group ctrlHolder">
          <h3><label for="id_mugshot">Photo</label></h3>
          <div>
            <input type="file" class="upload-file"
              name="mugshot" id="id_mugshot">
            {% if user_files.mugshot.value %}
              <a href="{{media_url}}{{user_files.mugshot.value}}" target="_blank">
              <i class="fa fa-file-image-o red" aria-hidden="true"></i></a>
            {% else %}
              <i class="fa fa-ban red" aria-hidden="true" title="Missing file"></i>
            {% endif %}
          </div>
        </li>
        <li class="form-group ctrlHolder">
          <h3><label for="id_biography">Biography</label></h3>
          <div>
            <input type="file" class="upload-file"
              name="biography" id="id_biography">
            {% if user_files.biography.value %}
              <a href="{{media_url}}{{user_files.biography.value}}" target="_blank">
              <i class="fa fa-file-pdf-o red" aria-hidden="true"></i></a>
            {% else %}
              <i class="fa fa-ban red" aria-hidden="true" title="Missing file"></i>
            {% endif %}
          </div>
        </li>
        <li class="form-group ctrlHolder">
          <h3><label for="id_irs_w9">W9 Form</label></h3>
          <div>
            <input type="file" class="upload-file"
              name="irs_w9" id="id_irs_w9">
            {% if user_files.irs_w9.value %}
              <a href="{{media_url}}{{user_files.irs_w9.value}}" target="_blank">
              <i class="fa fa-file-pdf-o red" aria-hidden="true"></i></a>
            {% else %}
              <i class="fa fa-ban red" aria-hidden="true" title="Missing file"></i>
            {% endif %}
          </div>
        </li>
        <li class="form-group ctrlHolder">
          <h3><label for="id_media_release">Media Release Form</label></h3>
          <div>
            <input type="file" class="upload-file"
              name="media_release" id="id_media_release">
            {% if user_files.media_release.value %}
              <a href="{{media_url}}{{user_files.media_release.value}}" target="_blank">
              <i class="fa fa-file-pdf-o red" aria-hidden="true"></i></a>
            {% else %}
              <i class="fa fa-ban red" aria-hidden="true" title="Missing file"></i>
            {% endif %}
          </div>
        </li>
      </ol>
    </fieldset>
    </form>
    {% endif %}
{% else %}
    {% if not user.profile.us_citizen %}
    <div class="notice">
        <p>
            <h4>
                You must be a United States citizen to apply
                for grants from NASA.
            </h4>
        </p>
    </div>
    {% endif %}
{% endif %}
</div>
<div class="column2 large-5 medium-12 small-12">
    {% if not reg %}
    <h2>Message Center</h2>
    <div class="notice">
    {% else %}
    <div class="info">
      <h2>Grant Application Forms</h2>
    </div>
    <div class="grant-list">
    {% endif %}
        <p>
            <h4>
                {% if not reg or not status %}
                <i class="fa fa-times red"></i>
                You must update your
                <a href="{% url 'dashboard_profile' %}"
                    style="color:blue;">
                    registration profile
                </a> before applying for grants from NASA.
                {% else %}
                <div style="margin-left:9px;">
                    {% include "dashboard/applications.inc.html" %}
                </div>
                {% endif %}
            </h4>
        </p>
    </div>
</div>
{% endblock %}
